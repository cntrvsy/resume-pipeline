name: CI

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  APP_NAME: resume-pipeline

jobs:
  # ---------------------------------------------------
  # 1. QUALITY CONTROL (Format, Lint, Test)
  # ---------------------------------------------------
  quality-check:
    name: Quality Control
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2

      # Check Formatting
      - run: cargo fmt -- --check

      # Check Linting
      - uses: clechasseur/rs-clippy-check@v3
        with:
          args: --all-features

      # Run Tests
      - run: cargo test --locked --all-features --all-targets

  # ---------------------------------------------------
  # 2. RELEASE BUILD (Runs ONLY on Tags v*)
  # ---------------------------------------------------
  release:
    name: Release ${{ matrix.label }}
    permissions:
      contents: write
    needs: quality-check
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # -----------------------
          # LINUX
          # -----------------------
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            label: linux-amd64
            # Install musl tools for static linking
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y musl-tools

          # -----------------------
          # MAC (Apple Silicon)
          # -----------------------
          - target: aarch64-apple-darwin
            os: macos-latest
            label: macos-silicon

          # -----------------------
          # MAC (Intel)
          # -----------------------
          - target: x86_64-apple-darwin
            os: macos-latest
            label: macos-intel

          # -----------------------
          # WINDOWS
          # -----------------------
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            label: windows-amd64

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      # 1. Install dependencies (Linux only)
      - name: Install dependencies
        if: matrix.install_cmd != ''
        run: ${{ matrix.install_cmd }}

      # 2. Build and Upload
      # This action handles building, zipping, and uploading automatically.
      - name: Build and Upload Asset
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          # The binary name in Cargo.toml
          bin: ${{ env.APP_NAME }}

          # The compilation target (e.g., windows-msvc)
          target: ${{ matrix.target }}

          # Renames the output file to: resume-pipeline-linux-amd64.tar.gz
          asset_name: ${{ env.APP_NAME }}-${{ matrix.label }}

          # BUNDLING: This puts the 'data' folder INSIDE the zip
          include: data

          token: ${{ secrets.GITHUB_TOKEN }}
